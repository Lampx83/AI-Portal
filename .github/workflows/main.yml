name: Docker Build and Deploy

on:
  push:
    branches: ['main']
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      # 1. Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Kiểm tra Docker và Docker Compose
      - name: Check Docker installation
        run: |
          docker --version
          docker-compose --version || docker compose version
          echo "Current directory: $(pwd)"
          echo "Workspace: ${{ github.workspace }}"
          ls -la

      # 3. Kiểm tra các file cần thiết
      - name: Check required files
        run: |
          if [ ! -f "docker-compose.yml" ]; then
            echo "❌ docker-compose.yml not found!"
            ls -la
            exit 1
          fi
          if [ ! -f "Dockerfile" ]; then
            echo "❌ Dockerfile not found!"
            exit 1
          fi
          echo "✅ All required files found"

      # 4. Tạo file .env trên server
      - name: Create .env file on server
        working-directory: ${{ github.workspace }}
        run: |
          cat > .env << EOF
          # Database
          POSTGRES_HOST=postgres
          POSTGRES_PORT=5432
          POSTGRES_DB=${{ secrets.POSTGRES_DB }}
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_SSL=false
          
          # NextAuth
          NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}
          NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
          
          # Azure AD
          AZURE_AD_CLIENT_ID=${{ secrets.AZURE_AD_CLIENT_ID }}
          AZURE_AD_CLIENT_SECRET=${{ secrets.AZURE_AD_CLIENT_SECRET }}
          AZURE_AD_TENANT_ID=${{ secrets.AZURE_AD_TENANT_ID }}
          
          # API
          NEXT_PUBLIC_API_BASE_URL=${{ secrets.NEXT_PUBLIC_API_BASE_URL }}
          
          # OpenAI
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          
          # MinIO (nếu có)
          MINIO_ENDPOINT=${{ secrets.MINIO_ENDPOINT }}
          MINIO_ENDPOINT_PUBLIC=${{ secrets.MINIO_ENDPOINT_PUBLIC }}
          MINIO_PORT=${{ secrets.MINIO_PORT }}
          MINIO_ACCESS_KEY=${{ secrets.MINIO_ACCESS_KEY }}
          MINIO_SECRET_KEY=${{ secrets.MINIO_SECRET_KEY }}
          MINIO_BUCKET_NAME=${{ secrets.MINIO_BUCKET_NAME }}
          
          # AWS S3 (nếu có)
          AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION=${{ secrets.AWS_REGION }}
          AWS_S3_BUCKET=${{ secrets.AWS_S3_BUCKET }}
          
          # App Port
          APP_PORT=3000
          EOF

      # 5. Xác định lệnh docker-compose
      - name: Determine docker-compose command
        id: docker_compose
        working-directory: ${{ github.workspace }}
        run: |
          if command -v docker-compose &> /dev/null; then
            echo "command=docker-compose" >> $GITHUB_OUTPUT
          else
            echo "command=docker compose" >> $GITHUB_OUTPUT
          fi
          echo "Working directory: $(pwd)"
          echo "docker-compose.yml exists: $([ -f docker-compose.yml ] && echo 'yes' || echo 'no')"

      # 6. Deploy với Docker Compose
      - name: Deploy with Docker Compose
        working-directory: ${{ github.workspace }}
        run: |
          set -e
          
          DOCKER_COMPOSE="${{ steps.docker_compose.outputs.command }}"
          WORKSPACE="${{ github.workspace }}"
          
          echo "Using: $DOCKER_COMPOSE"
          echo "Working directory: $(pwd)"
          echo "Workspace: $WORKSPACE"
          
          # Đảm bảo đang ở đúng thư mục
          cd "$WORKSPACE"
          
          # Kiểm tra lại file docker-compose.yml
          if [ ! -f "docker-compose.yml" ]; then
            echo "❌ docker-compose.yml not found in $(pwd)"
            ls -la
            exit 1
          fi
          
          # Backup image hiện tại (để rollback nếu cần)
          echo "Backing up current image..."
          docker tag research-app:latest research-app:backup-$(date +%Y%m%d-%H%M%S) 2>/dev/null || true
          
          # Dừng containers cũ (giữ lại volumes để không mất data)
          echo "Stopping old containers..."
          $DOCKER_COMPOSE -f docker-compose.yml down || true
          
          # Build lại image từ code mới
          echo "Building new Docker image..."
          $DOCKER_COMPOSE -f docker-compose.yml build --no-cache app
          
          # Khởi động services
          echo "Starting services..."
          $DOCKER_COMPOSE -f docker-compose.yml up -d
          
          # Đợi services khởi động
          echo "Waiting for services to be healthy..."
          sleep 15
          
          # Kiểm tra health của services
          $DOCKER_COMPOSE -f docker-compose.yml ps

      # 8. Cleanup old images
      - name: Cleanup old Docker images
        working-directory: ${{ github.workspace }}
        run: |
          # Xóa các images không được sử dụng (giữ lại 2 images gần nhất)
          docker image prune -f
          
          # Xóa các build cache cũ
          docker builder prune -f --filter "until=24h"

      # 7. Verify deployment
      - name: Verify deployment
        working-directory: ${{ github.workspace }}
        run: |
          set -e
          
          DOCKER_COMPOSE="${{ steps.docker_compose.outputs.command }}"
          WORKSPACE="${{ github.workspace }}"
          
          cd "$WORKSPACE"
          
          echo "Checking application health..."
          sleep 5
          
          # Kiểm tra xem app có đang chạy không
          APP_STATUS=$($DOCKER_COMPOSE -f docker-compose.yml ps app 2>/dev/null | grep -c "Up" || echo "0")
          
          if [ "$APP_STATUS" -gt 0 ]; then
            echo "✅ Application deployed successfully!"
            echo "Application logs:"
            $DOCKER_COMPOSE -f docker-compose.yml logs --tail=50 app
          else
            echo "❌ Application deployment failed!"
            echo "Full logs:"
            $DOCKER_COMPOSE -f docker-compose.yml logs app || true
            echo "PostgreSQL logs:"
            $DOCKER_COMPOSE -f docker-compose.yml logs postgres || true
            exit 1
          fi
          
          # Kiểm tra health endpoint nếu có
          echo "Testing application endpoint..."
          sleep 5
          if curl -f http://localhost:3000 > /dev/null 2>&1; then
            echo "✅ Application is responding!"
          else
            echo "⚠️  Application might still be starting up..."
          fi
