name: Docker Build and Deploy

on:
  push:
    branches: ['main']
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      # 1. Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Kiểm tra Docker và Docker Compose
      - name: Check Docker installation
        run: |
          docker --version
          docker-compose --version || docker compose version
          echo "Current directory: $(pwd)"
          echo "Workspace: ${{ github.workspace }}"
          ls -la

      # 3. Kiểm tra các file cần thiết
      - name: Check required files
        run: |
          if [ ! -f "docker-compose.yml" ]; then
            echo "❌ docker-compose.yml not found!"
            ls -la
            exit 1
          fi
          if [ ! -f "backend/Dockerfile" ]; then
            echo "❌ backend/Dockerfile not found!"
            exit 1
          fi
          if [ ! -f "frontend/Dockerfile" ]; then
            echo "❌ frontend/Dockerfile not found!"
            exit 1
          fi
          echo "✅ All required files found"

      # 4. Tạo file .env trên server
      - name: Create .env file on server
        working-directory: ${{ github.workspace }}
        run: |
          cat > .env << EOF
          # Database
          POSTGRES_HOST=postgres
          POSTGRES_PORT=5432
          POSTGRES_DB=${{ secrets.POSTGRES_DB }}
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_SSL=false
          
          # NextAuth
          NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}
          NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
          
          # Azure AD
          AZURE_AD_CLIENT_ID=${{ secrets.AZURE_AD_CLIENT_ID }}
          AZURE_AD_CLIENT_SECRET=${{ secrets.AZURE_AD_CLIENT_SECRET }}
          AZURE_AD_TENANT_ID=${{ secrets.AZURE_AD_TENANT_ID }}
          
          # API
          NEXT_PUBLIC_API_BASE_URL=${{ secrets.NEXT_PUBLIC_API_BASE_URL }}
          
          # Agent URLs (for backend - used by both backend and frontend via API)
          PAPER_AGENT_URL=${{ secrets.PAPER_AGENT_URL }}
          EXPERT_AGENT_URL=${{ secrets.EXPERT_AGENT_URL }}
          REVIEW_AGENT_URL=${{ secrets.REVIEW_AGENT_URL }}

          # Regulations embedding URL
          REGULATIONS_EMBEDDING_URL=${{ secrets.REGULATIONS_EMBEDDING_URL || '' }}
          REGULATIONS_EMBEDDING_MODEL=${{ secrets.REGULATIONS_EMBEDDING_MODEL || 'text-embedding-3-small' }}
          
          # Datalake / LakeFlow API (upload inbox, list documents — Admin tab Tài liệu RAG)
          LAKEFLOW_API_URL=${{ secrets.LAKEFLOW_API_URL }}
          
          # CORS
          CORS_ORIGIN=${{ secrets.CORS_ORIGIN }}
        
          
          # OpenAI
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          
          # MinIO (nếu có)
          MINIO_ENDPOINT=${{ secrets.MINIO_ENDPOINT }}
          MINIO_ENDPOINT_PUBLIC=${{ secrets.MINIO_ENDPOINT_PUBLIC }}
          MINIO_PORT=${{ secrets.MINIO_PORT }}
          MINIO_ACCESS_KEY=${{ secrets.MINIO_ACCESS_KEY }}
          MINIO_SECRET_KEY=${{ secrets.MINIO_SECRET_KEY }}
          MINIO_BUCKET_NAME=${{ secrets.MINIO_BUCKET_NAME }}
          
          # AWS S3 (nếu có)
          AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION=${{ secrets.AWS_REGION }}
          AWS_S3_BUCKET=${{ secrets.AWS_S3_BUCKET }}
          
          # App Port
          APP_PORT=3000
          EOF
 
      # 5. Xác định lệnh docker-compose
      - name: Determine docker-compose command
        id: docker_compose
        working-directory: ${{ github.workspace }}
        run: |
          if command -v docker-compose &> /dev/null; then
            echo "command=docker-compose" >> $GITHUB_OUTPUT
          else
            echo "command=docker compose" >> $GITHUB_OUTPUT
          fi
          echo "Working directory: $(pwd)"
          echo "docker-compose.yml exists: $([ -f docker-compose.yml ] && echo 'yes' || echo 'no')"

      # 6. Deploy với Docker Compose (không down trước → deploy lỗi vẫn không downtime)
      - name: Deploy with Docker Compose
        working-directory: ${{ github.workspace }}
        env:
          DOCKER_BUILDKIT: 1
          COMPOSE_DOCKER_CLI_BUILD: 1
        run: |
          set -e
          
          DOCKER_COMPOSE="${{ steps.docker_compose.outputs.command }}"
          WORKSPACE="${{ github.workspace }}"
          
          echo "Using: $DOCKER_COMPOSE"
          echo "Working directory: $(pwd)"
          echo "Workspace: $WORKSPACE"
          
          # Đảm bảo đang ở đúng thư mục
          cd "$WORKSPACE"
          
          # Kiểm tra lại file docker-compose.yml
          if [ ! -f "docker-compose.yml" ]; then
            echo "❌ docker-compose.yml not found in $(pwd)"
            ls -la
            exit 1
          fi
          
          # Build trước (containers cũ vẫn chạy). Nếu build lỗi → thoát, không đụng tới app đang chạy.
          echo "Building Docker images (with cache, parallel build)..."
          $DOCKER_COMPOSE -f docker-compose.yml build --parallel
          
          # Chỉ khi build xong mới up: thay containers bằng bản mới. --remove-orphans xóa container orphan.
          echo "Starting/updating services..."
          $DOCKER_COMPOSE -f docker-compose.yml up -d --remove-orphans
          
          # Đợi ngắn, healthcheck sẽ tự kiểm tra
          echo "Waiting for services to be healthy..."
          sleep 10
          
          # Kiểm tra health của services
          $DOCKER_COMPOSE -f docker-compose.yml ps

      # 7. Verify deployment
      - name: Verify deployment
        working-directory: ${{ github.workspace }}
        run: |
          set -e
          
          DOCKER_COMPOSE="${{ steps.docker_compose.outputs.command }}"
          WORKSPACE="${{ github.workspace }}"
          
          cd "$WORKSPACE"
          
          echo "Checking application health..."
          # Giảm sleep time, healthcheck sẽ tự kiểm tra
          sleep 2
          
          # Kiểm tra xem các services có đang chạy không
          FRONTEND_STATUS=$($DOCKER_COMPOSE -f docker-compose.yml ps frontend 2>/dev/null | grep -c "Up" || echo "0")
          BACKEND_STATUS=$($DOCKER_COMPOSE -f docker-compose.yml ps backend 2>/dev/null | grep -c "Up" || echo "0")
          POSTGRES_STATUS=$($DOCKER_COMPOSE -f docker-compose.yml ps postgres 2>/dev/null | grep -c "Up" || echo "0")
          
          if [ "$FRONTEND_STATUS" -gt 0 ] && [ "$BACKEND_STATUS" -gt 0 ] && [ "$POSTGRES_STATUS" -gt 0 ]; then
            echo "✅ All services deployed successfully!"
            echo "Frontend logs:"
            $DOCKER_COMPOSE -f docker-compose.yml logs --tail=50 frontend
            echo "Backend logs:"
            $DOCKER_COMPOSE -f docker-compose.yml logs --tail=50 backend
          else
            echo "❌ Some services failed to deploy!"
            echo "Frontend status: $FRONTEND_STATUS"
            echo "Backend status: $BACKEND_STATUS"
            echo "PostgreSQL status: $POSTGRES_STATUS"
            echo "Full logs:"
            $DOCKER_COMPOSE -f docker-compose.yml logs || true
            exit 1
          fi
          
          # Kiểm tra health endpoint nếu có
          echo "Testing application endpoints..."
          # Giảm sleep time
          sleep 2
          if curl -f http://localhost:3000 > /dev/null 2>&1; then
            echo "✅ Frontend is responding!"
          else
            echo "⚠️  Frontend might still be starting up..."
          fi
          if curl -f http://localhost:3001/health > /dev/null 2>&1; then
            echo "✅ Backend is responding!"
          else
            echo "⚠️  Backend might still be starting up..."
          fi

      # 8. Cleanup old images
      - name: Cleanup old Docker images
        working-directory: ${{ github.workspace }}
        run: |
          # Xóa các images không được sử dụng (giữ lại 2 images gần nhất)
          docker image prune -f
          
          # Xóa các build cache cũ
          docker builder prune -f --filter "until=24h"
