<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Viewer - Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 24px;
        }
        h1 {
            color: #333;
            margin-bottom: 24px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 12px;
        }
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .tab:hover {
            color: #007bff;
        }
        .tab.active {
            color: #007bff;
            border-bottom-color: #007bff;
            font-weight: 600;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
        }
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .config-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
        }
        .config-card h3 {
            font-size: 14px;
            color: #495057;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #dee2e6;
        }
        .config-row {
            margin-bottom: 12px;
            font-size: 13px;
        }
        .config-row label {
            display: block;
            color: #6c757d;
            margin-bottom: 4px;
        }
        .config-row code {
            display: block;
            padding: 8px;
            background: white;
            border-radius: 4px;
            word-break: break-all;
        }
        .table-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }
        .table-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .table-card:hover {
            background: #e9ecef;
            border-color: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .table-card h3 {
            color: #333;
            margin-bottom: 8px;
            font-size: 16px;
        }
        .table-card .meta {
            color: #666;
            font-size: 12px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
            background: white;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
        }
        tr:hover {
            background: #f8f9fa;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .error {
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 4px;
            margin: 16px 0;
        }
        .query-box {
            margin-bottom: 16px;
        }
        textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 8px;
        }
        button:hover {
            background: #0056b3;
        }
        .pagination {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            align-items: center;
        }
        .pagination button {
            padding: 6px 12px;
            background: #6c757d;
        }
        .pagination button:hover {
            background: #5a6268;
        }
        .pagination .info {
            color: #666;
            font-size: 14px;
        }
        /* Agents tab */
        .agents-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px; }
        .agent-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
        }
        .agent-card.inactive { opacity: 0.7; background: #e9ecef; }
        .agent-card .info { flex: 1; min-width: 0; }
        .agent-card .title { font-weight: 600; color: #333; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; }
        .agent-card .badge { font-size: 11px; padding: 2px 8px; border-radius: 4px; }
        .agent-card .badge.inactive { background: #ffc107; color: #333; }
        .agent-card .url { font-size: 13px; color: #666; word-break: break-all; margin-top: 4px; }
        .agent-card .actions { display: flex; gap: 4px; flex-shrink: 0; }
        .agent-card button { margin: 0; padding: 6px 10px; font-size: 13px; }
        .agent-card button.restore { background: #28a745; }
        .agent-card button.restore:hover { background: #218838; }
        .agent-card button.delete { background: #dc3545; }
        .agent-card button.delete:hover { background: #c82333; }
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-overlay.show { display: flex; }
        .modal {
            background: white;
            border-radius: 8px;
            max-width: 520px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal h2 { padding: 20px 20px 0; margin-bottom: 16px; font-size: 18px; }
        .modal form { padding: 0 20px 20px; }
        .modal .form-row { margin-bottom: 16px; }
        .modal label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 13px; }
        .modal input, .modal select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .modal .form-row-inline { display: flex; gap: 16px; align-items: center; }
        .modal .form-row-inline .col { flex: 1; }
        .modal .form-actions { margin-top: 20px; display: flex; gap: 12px; justify-content: flex-end; }
        .modal .form-actions button.cancel { background: #6c757d; }
        .modal .form-actions button.cancel:hover { background: #5a6268; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üóÑÔ∏è Database Viewer - Admin Panel</h1>
        
        <div class="tabs">
            <button class="tab" data-tab="config" onclick="showTab('config')">C·∫•u h√¨nh</button>
            <button class="tab" data-tab="stats" onclick="showTab('stats')">Th·ªëng k√™</button>
            <button class="tab" data-tab="tables" onclick="showTab('tables')">Tables</button>
            <button class="tab" data-tab="query" onclick="showTab('query')">SQL Query</button>
            <button class="tab" data-tab="agents" onclick="showTab('agents')">Qu·∫£n l√Ω Agents</button>
        </div>
        
        <!-- Config Tab -->
        <div id="config" class="tab-content">
            <div class="config-grid" id="configContent">
                <div class="loading">ƒêang t·∫£i c·∫•u h√¨nh...</div>
            </div>
        </div>
        
        <!-- Stats Tab -->
        <div id="stats" class="tab-content">
            <div class="stats-grid" id="statsGrid">
                <div class="loading">ƒêang t·∫£i th·ªëng k√™...</div>
            </div>
        </div>
        
        <!-- Tables Tab -->
        <div id="tables" class="tab-content">
            <div id="tablesList" class="table-list">
                <div class="loading">ƒêang t·∫£i danh s√°ch tables...</div>
            </div>
            <div id="tableData"></div>
        </div>
        
        <!-- Agents Tab -->
        <div id="agents" class="tab-content">
            <div class="agents-header">
                <h2 style="margin:0; font-size:16px;">Qu·∫£n l√Ω Agents (bao g·ªìm agent ch√≠nh/main)</h2>
                <button onclick="showAgentModal()">+ Th√™m Agent</button>
            </div>
            <div id="agentsList">
                <div class="loading">ƒêang t·∫£i danh s√°ch agents...</div>
            </div>
            <label style="display:flex;align-items:center;gap:8px;margin-top:16px;cursor:pointer;font-size:14px;">
                <input type="checkbox" id="showInactiveAgents" checked onchange="loadAgents()"> Hi·ªÉn th·ªã c·∫£ agent ƒë√£ v√¥ hi·ªáu h√≥a
            </label>
        </div>
        
        <div id="agentModalOverlay" class="modal-overlay">
            <div class="modal">
                <h2 id="agentModalTitle">Th√™m Agent m·ªõi</h2>
                <form id="agentForm" onsubmit="saveAgent(event)">
                    <input type="hidden" id="agentId">
                    <div class="form-row">
                        <label>Alias *</label>
                        <input type="text" id="agentAlias" required placeholder="main, documents, experts..." pattern="[a-z0-9_-]+" title="Ch·ªØ th∆∞·ªùng, s·ªë, g·∫°ch ngang, g·∫°ch d∆∞·ªõi">
                        <small style="color:#666;font-size:11px;">Ch·ªØ th∆∞·ªùng, s·ªë, g·∫°ch ngang, g·∫°ch d∆∞·ªõi</small>
                    </div>
                    <div class="form-row">
                        <label>Icon</label>
                        <select id="agentIcon">
                            <option value="Bot">Bot</option>
                            <option value="Users">Users</option>
                            <option value="FileText">FileText</option>
                            <option value="Database">Database</option>
                            <option value="ListTodo">ListTodo</option>
                            <option value="ShieldCheck">ShieldCheck</option>
                            <option value="Award">Award</option>
                            <option value="Newspaper">Newspaper</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label>Base URL *</label>
                        <input type="url" id="agentBaseUrl" required placeholder="http://localhost:3001/api/main_agent/v1">
                    </div>
                    <div class="form-row">
                        <label>Domain URL (t√πy ch·ªçn)</label>
                        <input type="url" id="agentDomainUrl" placeholder="https://research.neu.edu.vn/api/agents/...">
                    </div>
                    <div class="form-row form-row-inline">
                        <div class="col">
                            <label>Th·ª© t·ª± hi·ªÉn th·ªã</label>
                            <input type="number" id="agentDisplayOrder" value="0" min="0">
                        </div>
                        <div class="col" style="flex:0;">
                            <label>&nbsp;</label>
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                                <input type="checkbox" id="agentIsActive" checked> K√≠ch ho·∫°t
                            </label>
                        </div>
                    </div>
                    <div class="form-row">
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                            <input type="checkbox" id="agentIsInternal"> Agent n·ªôi b·ªô (base_url t·ª± resolve)
                        </label>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="cancel" onclick="closeAgentModal()">H·ªßy</button>
                        <button type="submit">L∆∞u</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Query Tab -->
        <div id="query" class="tab-content">
            <div class="query-box">
                <textarea id="sqlQuery" placeholder="SELECT * FROM research_chat.users LIMIT 10;">SELECT * FROM research_chat.users LIMIT 10;</textarea>
                <button onclick="executeQuery()">Th·ª±c thi Query</button>
            </div>
            <div id="queryResult"></div>
        </div>
    </div>
    
    <script>
        const API_BASE = window.location.origin + '/api/admin';
        
        const VALID_TABS = ['config', 'stats', 'tables', 'query', 'agents'];
        function showTab(tabName) {
            if (!VALID_TABS.includes(tabName)) tabName = 'stats';
            location.hash = tabName;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            const btn = document.querySelector('.tab[data-tab="' + tabName + '"]');
            if (btn) btn.classList.add('active');
            const content = document.getElementById(tabName);
            if (content) content.classList.add('active');
            if (tabName === 'config') loadConfig();
            if (tabName === 'stats') loadStats();
            if (tabName === 'tables') loadTables();
            if (tabName === 'agents') loadAgents();
        }
        
        async function loadConfig() {
            const el = document.getElementById('configContent');
            if (!el) return;
            try {
                const [configRes, dbRes] = await Promise.all([
                    fetch(`${API_BASE}/config`, { credentials: 'include' }),
                    fetch(`${API_BASE}/db/connection-info`, { credentials: 'include' })
                ]);
                const data = await configRes.json();
                const dbData = await dbRes.json().catch(() => ({}));
                if (!configRes.ok) throw new Error(data.error || 'HTTP ' + configRes.status);
                const b = data.backend || {};
                const f = data.frontend || {};
                const a = data.auth || {};
                const o = data.openai || {};
                const db = dbData.host ? dbData : null;
                el.innerHTML = `
                    <div class="config-card">
                        <h3>Backend</h3>
                        <div class="config-row"><label>Backend URL</label><code>${escapeHtml(b.url)}</code></div>
                        <div class="config-row"><label>Port</label><code>${escapeHtml(b.port)}</code></div>
                        <div class="config-row"><label>NODE_ENV</label><code>${escapeHtml(b.nodeEnv)}</code></div>
                        <div class="config-row"><label>Admin routes</label><code>${b.enableAdminRoutes ? 'B·∫≠t' : 'T·∫Øt'}</code></div>
                    </div>
                    <div class="config-card">
                        <h3>Frontend</h3>
                        <div class="config-row"><label>NEXTAUTH_URL / FRONTEND_URL</label><code>${escapeHtml(f.url)}</code></div>
                        <div class="config-row"><label>NEXT_PUBLIC_API_BASE_URL</label><code>${escapeHtml(f.nextPublicApiBase)}</code></div>
                    </div>
                    <div class="config-card">
                        <h3>Auth</h3>
                        <div class="config-row"><label>NEXTAUTH</label><code>${escapeHtml(a.nextAuthUrl)}</code></div>
                        <div class="config-row"><label>ADMIN_SECRET</label><code>${escapeHtml(a.adminSecret)}</code></div>
                    </div>
                    <div class="config-card">
                        <h3>OpenAI</h3>
                        <div class="config-row"><label>OPENAI_API_KEY</label><code>${escapeHtml(o.apiKey)}</code></div>
                    </div>
                    ${db ? `
                    <div class="config-card">
                        <h3>Database</h3>
                        <div class="config-row"><label>Host</label><code>${escapeHtml(db.host)}</code></div>
                        <div class="config-row"><label>Port</label><code>${escapeHtml(db.port)}</code></div>
                        <div class="config-row"><label>Database</label><code>${escapeHtml(db.database)}</code></div>
                        <div class="config-row"><label>User</label><code>${escapeHtml(db.user)}</code></div>
                        <div class="config-row"><label>Password</label><code>${escapeHtml(db.password || '')}</code></div>
                    </div>
                    ` : ''}
                `;
            } catch (err) {
                el.innerHTML = `<div class="error">L·ªói: ${escapeHtml(err.message)}</div>`;
            }
        }
        
        async function loadStats() {
            try {
                const res = await fetch(`${API_BASE}/db/stats`);
                const data = await res.json();
                
                const html = data.stats.map(stat => `
                    <div class="stat-card">
                        <h3>${stat.table_name}</h3>
                        <div class="value">${stat.row_count}</div>
                    </div>
                `).join('');
                
                document.getElementById('statsGrid').innerHTML = html;
            } catch (err) {
                document.getElementById('statsGrid').innerHTML = `<div class="error">L·ªói: ${err.message}</div>`;
            }
        }
        
        async function loadTables() {
            try {
                const res = await fetch(`${API_BASE}/db/tables`);
                const data = await res.json();
                
                const html = data.tables.map(table => `
                    <div class="table-card" onclick="loadTableData('${table.table_name}')">
                        <h3>${table.table_name}</h3>
                        <div class="meta">Schema: ${table.table_schema} ‚Ä¢ Columns: ${table.column_count}</div>
                    </div>
                `).join('');
                
                document.getElementById('tablesList').innerHTML = html;
            } catch (err) {
                document.getElementById('tablesList').innerHTML = `<div class="error">L·ªói: ${err.message}</div>`;
            }
        }
        
        async function loadTableData(tableName) {
            document.getElementById('tableData').innerHTML = '<div class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>';
            
            try {
                const res = await fetch(`${API_BASE}/db/table/${tableName}?limit=100`);
                const data = await res.json();
                
                if (data.data.length === 0) {
                    document.getElementById('tableData').innerHTML = '<div class="error">Kh√¥ng c√≥ d·ªØ li·ªáu</div>';
                    return;
                }
                
                const columns = Object.keys(data.data[0]);
                const header = `<h2>${data.table} (${data.pagination.total} rows)</h2>`;
                const tableHeader = `<tr>${columns.map(col => `<th>${col}</th>`).join('')}</tr>`;
                const tableRows = data.data.map(row => 
                    `<tr>${columns.map(col => `<td>${formatValue(row[col])}</td>`).join('')}</tr>`
                ).join('');
                
                document.getElementById('tableData').innerHTML = `
                    ${header}
                    <div style="overflow-x: auto; max-height: 600px; overflow-y: auto;">
                        <table>
                            ${tableHeader}
                            ${tableRows}
                        </table>
                    </div>
                `;
            } catch (err) {
                document.getElementById('tableData').innerHTML = `<div class="error">L·ªói: ${err.message}</div>`;
            }
        }
        
        async function executeQuery() {
            const sql = document.getElementById('sqlQuery').value.trim();
            if (!sql) return;
            
            document.getElementById('queryResult').innerHTML = '<div class="loading">ƒêang th·ª±c thi query...</div>';
            
            try {
                const res = await fetch(`${API_BASE}/db/query`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sql })
                });
                
                const data = await res.json();
                
                if (data.error) {
                    document.getElementById('queryResult').innerHTML = `<div class="error">L·ªói: ${data.message || data.error}</div>`;
                    return;
                }
                
                if (data.rows.length === 0) {
                    document.getElementById('queryResult').innerHTML = '<div class="error">Kh√¥ng c√≥ k·∫øt qu·∫£</div>';
                    return;
                }
                
                const columns = data.columns;
                const tableHeader = `<tr>${columns.map(col => `<th>${col}</th>`).join('')}</tr>`;
                const tableRows = data.rows.map(row => 
                    `<tr>${columns.map(col => `<td>${formatValue(row[col])}</td>`).join('')}</tr>`
                ).join('');
                
                document.getElementById('queryResult').innerHTML = `
                    <div style="margin-top: 16px;">
                        <div class="pagination info">K·∫øt qu·∫£: ${data.rowCount} rows</div>
                        <div style="overflow-x: auto; max-height: 600px; overflow-y: auto;">
                            <table>
                                ${tableHeader}
                                ${tableRows}
                            </table>
                        </div>
                    </div>
                `;
            } catch (err) {
                document.getElementById('queryResult').innerHTML = `<div class="error">L·ªói: ${err.message}</div>`;
            }
        }
        
        function formatValue(value) {
            if (value === null || value === undefined) return '<em style="color: #999;">null</em>';
            if (typeof value === 'object') return JSON.stringify(value);
            if (typeof value === 'boolean') return value ? '‚úì' : '‚úó';
            return String(value);
        }
        
        // Agents management
        async function loadAgents() {
            const el = document.getElementById('agentsList');
            if (!el) return;
            el.innerHTML = '<div class="loading">ƒêang t·∫£i...</div>';
            try {
                const res = await fetch(`${API_BASE}/agents`, { credentials: 'include' });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || data.message || 'HTTP ' + res.status);
                const agents = data.agents || [];
                const showInactive = document.getElementById('showInactiveAgents')?.checked ?? true;
                const filtered = showInactive ? agents : agents.filter(a => a.is_active);
                if (filtered.length === 0) {
                    el.innerHTML = '<div class="loading">Ch∆∞a c√≥ agent n√†o</div>';
                    return;
                }
                el.innerHTML = filtered.map(a => `
                    <div class="agent-card ${a.is_active ? '' : 'inactive'}">
                        <div class="info">
                            <div class="title">
                                ${a.alias}
                                ${a.alias === 'main' ? '<span class="badge" style="background:#007bff;color:white;">Agent ch√≠nh</span>' : ''}
                                ${(a.config_json && a.config_json.isInternal) ? '<span class="badge" style="background:#6c757d;color:white;">N·ªôi b·ªô</span>' : ''}
                                ${!a.is_active ? '<span class="badge inactive">ƒê√£ v√¥ hi·ªáu h√≥a</span>' : ''}
                                <span style="font-size:12px;color:#999;">#${a.display_order}</span>
                            </div>
                            <div class="url">${escapeHtml(a.base_url)}</div>
                            ${a.domain_url ? `<div class="url" style="font-size:11px;">${escapeHtml(a.domain_url)}</div>` : ''}
                        </div>
                        <div class="actions">
                            <button onclick="showAgentModal('${a.id}')" title="S·ª≠a">S·ª≠a</button>
                            ${a.is_active 
                                ? `<button class="delete" onclick="deactivateAgent('${a.id}','${escapeHtml(a.alias)}')" title="V√¥ hi·ªáu h√≥a">V√¥ hi·ªáu h√≥a</button>`
                                : `<button class="restore" onclick="restoreAgent('${a.id}','${escapeHtml(a.alias)}')" title="Kh√¥i ph·ª•c">Kh√¥i ph·ª•c</button>`
                            }
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                el.innerHTML = `<div class="error">L·ªói: ${escapeHtml(err.message)}</div>`;
            }
        }
        
        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
        
        function showAgentModal(id) {
            const overlay = document.getElementById('agentModalOverlay');
            const form = document.getElementById('agentForm');
            document.getElementById('agentModalTitle').textContent = id ? 'S·ª≠a Agent' : 'Th√™m Agent m·ªõi';
            document.getElementById('agentId').value = id || '';
            if (id) {
                fetch(`${API_BASE}/agents/${id}`, { credentials: 'include' })
                    .then(r => r.json())
                    .then(data => {
                        const a = data.agent;
                        document.getElementById('agentAlias').value = a.alias || '';
                        document.getElementById('agentIcon').value = a.icon || 'Bot';
                        document.getElementById('agentBaseUrl').value = a.base_url || '';
                        document.getElementById('agentDomainUrl').value = a.domain_url || '';
                        document.getElementById('agentDisplayOrder').value = a.display_order ?? 0;
                        document.getElementById('agentIsActive').checked = a.is_active !== false;
                        document.getElementById('agentIsInternal').checked = (a.config_json && a.config_json.isInternal) === true;
                    });
            } else {
                form.reset();
                document.getElementById('agentId').value = '';
                document.getElementById('agentDisplayOrder').value = document.getElementById('agentsList')?.children?.length || 0;
                document.getElementById('agentIsActive').checked = true;
                document.getElementById('agentIsInternal').checked = false;
            }
            overlay.classList.add('show');
        }
        
        function closeAgentModal() {
            document.getElementById('agentModalOverlay').classList.remove('show');
        }
        
        async function saveAgent(e) {
            e.preventDefault();
            const id = document.getElementById('agentId').value;
            const alias = document.getElementById('agentAlias').value.trim().toLowerCase();
            const icon = document.getElementById('agentIcon').value;
            const base_url = document.getElementById('agentBaseUrl').value.trim();
            const domain_url = document.getElementById('agentDomainUrl').value.trim() || null;
            const display_order = parseInt(document.getElementById('agentDisplayOrder').value) || 0;
            const is_active = document.getElementById('agentIsActive').checked;
            const isInternal = document.getElementById('agentIsInternal').checked;
            const config_json = { isInternal };
            const body = { alias, icon, base_url, domain_url, display_order, is_active, config_json };
            const url = id ? `${API_BASE}/agents/${id}` : `${API_BASE}/agents`;
            const method = id ? 'PATCH' : 'POST';
            try {
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(body)
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) throw new Error(data.error || data.message || 'HTTP ' + res.status);
                closeAgentModal();
                loadAgents();
                alert(id ? 'ƒê√£ c·∫≠p nh·∫≠t agent' : 'ƒê√£ th√™m agent m·ªõi');
            } catch (err) {
                alert('L·ªói: ' + err.message);
            }
        }
        
        async function deactivateAgent(id, alias) {
            if (!confirm('V√¥ hi·ªáu h√≥a agent "' + alias + '"?')) return;
            try {
                const res = await fetch(`${API_BASE}/agents/${id}`, { method: 'DELETE', credentials: 'include' });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) throw new Error(data.error || data.message || 'HTTP ' + res.status);
                loadAgents();
                alert('ƒê√£ v√¥ hi·ªáu h√≥a agent');
            } catch (err) {
                alert('L·ªói: ' + err.message);
            }
        }
        
        async function restoreAgent(id, alias) {
            try {
                const res = await fetch(`${API_BASE}/agents/${id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ is_active: true })
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) throw new Error(data.error || data.message || 'HTTP ' + res.status);
                loadAgents();
                alert('ƒê√£ k√≠ch ho·∫°t l·∫°i agent');
            } catch (err) {
                alert('L·ªói: ' + err.message);
            }
        }
        
        document.getElementById('agentModalOverlay').addEventListener('click', function(e) {
            if (e.target === this) closeAgentModal();
        });
        
        // Load tab from hash on page load (gi·ªØ tab khi refresh)
        (function init() {
            const hash = (location.hash || '').replace(/^#/, '');
            const tab = VALID_TABS.includes(hash) ? hash : 'stats';
            showTab(tab);
        })();
        window.addEventListener('hashchange', function() {
            const hash = (location.hash || '').replace(/^#/, '');
            if (VALID_TABS.includes(hash)) showTab(hash);
        });
    </script>
</body>
</html>
