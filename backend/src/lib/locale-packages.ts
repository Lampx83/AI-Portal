/**
 * Locale packages: default strings in code (DEFAULT_LOCALE_STRINGS).
 * Admin can download template (GET locale-packages/template) and upload new locale → write to data/locales/{locale}.json.
 * readLocaleFile: prefer data/locales/{locale}.json, else fallback to DEFAULT_LOCALE_STRINGS.
 */
import fs from "fs/promises"
import path from "path"

/** Locale package directory for admin upload/config (data/locales). */
const LOCALES_DIR = path.join(process.cwd(), "data", "locales")

/** Built-in locale codes in code (fallback when no file in data/locales). */
const BUILTIN_LOCALE_CODES = ["en", "vi", "zh", "ja", "fr"] as const

const DEFAULT_EN: Record<string, string> = {
  "app.title": "AI Portal – UI and orchestration platform for AI",
  "app.description": "UI and orchestration platform for AI: projects, assistants, integration and display.",
  "app.shortName": "AI Portal",
  "app.keywords": "AI, projects, assistants, integration",
  "app.author": "AI Portal",
  "nav.home": "Back to home",
  "nav.adminTitle": "Admin Dashboard",
  "nav.adminShort": "Admin",
  "settings.title": "System Settings",
  "settings.subtitle": "Customize your AI Portal experience",
  "settings.appearance": "Appearance",
  "settings.appearanceDesc": "Language and display",
  "settings.language": "Language",
  "settings.theme": "Theme",
  "settings.themeLight": "Light",
  "settings.themeDark": "Dark",
  "settings.themeSystem": "System",
  "settings.langVi": "Tiếng Việt",
  "settings.langEn": "English",
  "settings.notifications": "Notifications",
  "settings.notificationsDesc": "Manage notification types. Default: all off.",
  "settings.notificationsEmailTo": "Notifications will be sent to email:",
  "settings.notificationsEmail": "Email notifications",
  "settings.notificationsPush": "Push notifications",
  "settings.notificationsProjects": "Project updates",
  "settings.notificationsPublications": "Publication opportunities",
  "settings.privacy": "Privacy",
  "settings.privacyDesc": "Control what information is visible. Default: all off.",
  "settings.privacyProfile": "Profile visible",
  "settings.privacyProjects": "Projects visible",
  "settings.privacyPublications": "Publications visible",
  "settings.ai": "AI Assistant",
  "settings.aiDesc": "Customize AI behavior",
  "settings.aiPersonalization": "Personalization",
  "settings.aiAutoSuggestions": "Auto suggestions",
  "settings.aiExternalSearch": "Search for information from external sources",
  "settings.aiResponseLength": "Response length",
  "settings.aiResponseShort": "Short",
  "settings.aiResponseMedium": "Medium",
  "settings.aiResponseLong": "Long",
  "settings.aiCreativity": "Creativity",
  "settings.data": "Data",
  "settings.dataDesc": "Storage and sync",
  "settings.dataAutoBackup": "Auto backup",
  "settings.dataSync": "Cloud sync",
  "settings.dataCacheSize": "Cache size",
  "settings.dataClearCache": "Clear cache",
  "settings.dataExport": "Export data",
  "settings.save": "Save settings",
  "settings.saving": "Saving...",
  "settings.saved": "Settings saved",
  "welcome.subtitle": "Your intelligent platform for AI-powered work and collaboration",
  "welcome.card1.title": "AI Portal",
  "welcome.card1.description": "A unified platform to interact with AI assistants, manage projects and extend your workflow.",
  "welcome.card2.title": "Chat & Collaborate",
  "welcome.card2.description": "Have natural conversations with AI and collaborate on your tasks.",
  "welcome.card3.title": "Projects & Tools",
  "welcome.card3.description": "Organize work in projects and integrate tools as needed.",
  "welcome.card4.title": "Customize",
  "welcome.card4.description": "Choose assistants and settings that fit your needs.",
  "welcome.startButton": "Get started",
  "welcome.loginButton": "Log in",
  "welcome.guideButton": "User guide",
  "welcome.hintLoggedIn": "You will be taken to AI Central to start chatting.",
  "welcome.hintLoggedOut": "Log in to create projects, save articles and view chat history.",
  "common.save": "Save",
  "common.saving": "Saving…",
  "common.add": "Add",
  "common.cancel": "Cancel",
  "common.delete": "Delete",
  "common.loading": "Loading…",
  "common.error": "Error",
  "common.refresh": "Refresh",
  "common.actions": "Actions",
  "common.filter": "Filter",
  "common.upload": "Upload",
  "common.saveError": "Save error",
  "admin.settings.languageTitle": "Language configuration",
  "admin.settings.languageDesc": "Choose the default language for the website. JSON files (en, vi, zh, ja, fr) are the initial config; you can download a template, edit and upload to data/locales.",
  "admin.settings.defaultLocaleSaved": "Default language saved. The interface will update to the new language.",
  "admin.settings.defaultLocale": "Default language",
  "admin.settings.localePackage": "Language package",
  "admin.settings.downloadTemplate": "Download language package template",
  "admin.settings.localeCodePlaceholder": "Locale code (e.g. fr, de)",
  "admin.settings.uploadPackage": "Upload package",
  "admin.settings.uploading": "Uploading…",
  "admin.settings.pluginQdrant": "Plugin Qdrant",
  "admin.settings.pluginQdrantDesc": "Enable the plugin to show the Qdrant tab in Admin; enter the Qdrant URL to manage the vector DB.",
  "admin.settings.enablePluginQdrant": "Enable Qdrant plugin",
  "admin.settings.qdrantUrl": "Qdrant URL",
  "admin.settings.qdrantUrlPlaceholder": "http://localhost:8010 or http://qdrant:6333",
  "admin.settings.qdrantSaved": "Saved. The Qdrant tab will appear when the plugin is enabled.",
  "admin.settings.envConfigTitle": "Environment config (read-only)",
  "admin.settings.envConfigDesc": "App name, icon, database: configure at /setup. The variables below can be saved via Admin and are loaded from app_settings on startup.",
  "admin.settings.resetTitle": "Reset application",
  "admin.settings.resetDesc": "Delete the entire database and recreate from schema.sql — application returns to fresh install state. Cannot be undone.",
  "admin.settings.resetConfirmLabel": "Type RESET to confirm",
  "admin.settings.resetConfirmError": "Type RESET (uppercase) to confirm.",
  "admin.settings.resetConfirmDialog": "Are you sure you want to delete all data and reset? This cannot be undone.",
  "admin.settings.resetDone": "Database has been reset.",
  "admin.settings.resetting": "Resetting…",
  "admin.settings.resetDatabase": "Reset database",
  "admin.settings.secretValue": "(value hidden)",
  "admin.settings.loading": "Loading configuration…",
  "admin.settings.loadError": "Failed to load configuration",
}

const DEFAULT_VI: Record<string, string> = {
  "app.title": "AI Portal – Nền tảng giao diện và điều phối AI",
  "app.description": "Nền tảng giao diện và điều phối AI: quản lý dự án, trợ lý ảo, tích hợp và hiển thị AI.",
  "app.shortName": "AI Portal",
  "app.keywords": "AI, dự án, trợ lý ảo, quản lý dự án, tích hợp AI",
  "app.author": "AI Portal",
  "nav.home": "Về trang chủ",
  "nav.adminTitle": "Admin Dashboard",
  "nav.adminShort": "Admin",
  "settings.title": "Cài đặt hệ thống",
  "settings.subtitle": "Tùy chỉnh trải nghiệm sử dụng AI Portal",
  "settings.appearance": "Giao diện",
  "settings.appearanceDesc": "Tùy chỉnh ngôn ngữ và giao diện",
  "settings.language": "Ngôn ngữ",
  "settings.theme": "Chủ đề",
  "settings.themeLight": "Sáng",
  "settings.themeDark": "Tối",
  "settings.themeSystem": "Theo hệ thống",
  "settings.langVi": "Tiếng Việt",
  "settings.langEn": "English",
  "settings.notifications": "Thông báo",
  "settings.notificationsDesc": "Quản lý các loại thông báo. Mặc định tắt.",
  "settings.notificationsEmailTo": "Thông báo sẽ gửi đến email:",
  "settings.notificationsEmail": "Thông báo email",
  "settings.notificationsPush": "Thông báo đẩy",
  "settings.notificationsProjects": "Cập nhật dự án",
  "settings.notificationsPublications": "Cơ hội công bố",
  "settings.privacy": "Quyền riêng tư",
  "settings.privacyDesc": "Kiểm soát thông tin hiển thị. Mặc định tắt.",
  "settings.privacyProfile": "Hồ sơ công khai",
  "settings.privacyProjects": "Dự án công khai",
  "settings.privacyPublications": "Công bố công khai",
  "settings.ai": "Trợ lý AI",
  "settings.aiDesc": "Tùy chỉnh hành vi của AI",
  "settings.aiPersonalization": "Cá nhân hóa",
  "settings.aiAutoSuggestions": "Gợi ý tự động",
  "settings.aiExternalSearch": "Tìm kiếm thông tin từ bên ngoài",
  "settings.aiResponseLength": "Độ dài phản hồi",
  "settings.aiResponseShort": "Ngắn",
  "settings.aiResponseMedium": "Trung bình",
  "settings.aiResponseLong": "Dài",
  "settings.aiCreativity": "Độ sáng tạo",
  "settings.data": "Dữ liệu",
  "settings.dataDesc": "Quản lý lưu trữ và đồng bộ",
  "settings.dataAutoBackup": "Sao lưu tự động",
  "settings.dataSync": "Đồng bộ đám mây",
  "settings.dataCacheSize": "Kích thước cache",
  "settings.dataClearCache": "Xóa cache",
  "settings.dataExport": "Xuất dữ liệu",
  "settings.save": "Lưu cài đặt",
  "settings.saving": "Đang lưu...",
  "settings.saved": "Đã lưu cài đặt",
  "welcome.subtitle": "Nền tảng thông minh cho công việc và hợp tác với AI",
  "welcome.card1.title": "AI Portal",
  "welcome.card1.description": "Nền tảng thống nhất để tương tác với trợ lý AI, quản lý dự án và mở rộng quy trình làm việc.",
  "welcome.card2.title": "Chat & Hợp tác",
  "welcome.card2.description": "Trò chuyện tự nhiên với AI và phối hợp xử lý công việc.",
  "welcome.card3.title": "Dự án & Công cụ",
  "welcome.card3.description": "Tổ chức công việc trong dự án và tích hợp công cụ khi cần.",
  "welcome.card4.title": "Tùy chỉnh",
  "welcome.card4.description": "Chọn trợ lý và cài đặt phù hợp với nhu cầu của bạn.",
  "welcome.startButton": "Bắt đầu sử dụng",
  "welcome.loginButton": "Đăng nhập",
  "welcome.guideButton": "Hướng dẫn sử dụng",
  "welcome.hintLoggedIn": "Bạn sẽ được chuyển đến AI Central để bắt đầu trò chuyện.",
  "welcome.hintLoggedOut": "Đăng nhập để tạo dự án, lưu bài viết và xem lịch sử chat.",
  "common.save": "Lưu",
  "common.saving": "Đang lưu…",
  "common.add": "Thêm",
  "common.cancel": "Hủy",
  "common.delete": "Xóa",
  "common.loading": "Đang tải…",
  "common.error": "Lỗi",
  "common.refresh": "Làm mới",
  "common.actions": "Thao tác",
  "common.filter": "Lọc",
  "common.upload": "Tải lên",
  "common.saveError": "Lỗi lưu",
  "admin.settings.languageTitle": "Cấu hình ngôn ngữ",
  "admin.settings.languageDesc": "Chọn ngôn ngữ mặc định cho website. Các file JSON (en, vi, zh, ja, fr) là cấu hình ban đầu; có thể tải mẫu gói ngôn ngữ, chỉnh sửa và upload vào data/locales.",
  "admin.settings.defaultLocaleSaved": "Đã lưu ngôn ngữ mặc định. Giao diện sẽ cập nhật theo ngôn ngữ mới.",
  "admin.settings.defaultLocale": "Ngôn ngữ mặc định",
  "admin.settings.localePackage": "Gói ngôn ngữ",
  "admin.settings.downloadTemplate": "Tải mẫu gói ngôn ngữ",
  "admin.settings.localeCodePlaceholder": "Mã ngôn ngữ (vd. fr, de)",
  "admin.settings.uploadPackage": "Upload gói",
  "admin.settings.uploading": "Đang tải lên…",
  "admin.settings.pluginQdrant": "Plugin Qdrant",
  "admin.settings.pluginQdrantDesc": "Bật plugin để hiển thị tab Qdrant trong Admin, nhập địa chỉ Qdrant để quản lý vector DB.",
  "admin.settings.enablePluginQdrant": "Bật plugin Qdrant",
  "admin.settings.qdrantUrl": "Địa chỉ Qdrant (URL)",
  "admin.settings.qdrantUrlPlaceholder": "http://localhost:8010 hoặc http://qdrant:6333",
  "admin.settings.qdrantSaved": "Đã lưu. Tab Qdrant sẽ hiển thị khi bật plugin.",
  "admin.settings.envConfigTitle": "Cấu hình môi trường (chỉ đọc)",
  "admin.settings.envConfigDesc": "Tên ứng dụng, icon, tên database: cấu hình tại /setup. Các biến bên dưới có thể lưu qua Admin và được nạp từ app_settings khi khởi động.",
  "admin.settings.resetTitle": "Reset ứng dụng",
  "admin.settings.resetDesc": "Xoá toàn bộ database đã tạo và tạo lại từ schema.sql — ứng dụng về trạng thái cài mới. Không thể hoàn tác.",
  "admin.settings.resetConfirmLabel": "Nhập RESET để xác nhận",
  "admin.settings.resetConfirmError": "Nhập đúng chữ RESET (viết hoa) để xác nhận.",
  "admin.settings.resetConfirmDialog": "Bạn chắc chắn muốn xoá toàn bộ dữ liệu và thiết lập lại? Hành động này không thể hoàn tác.",
  "admin.settings.resetDone": "Đã reset database.",
  "admin.settings.resetting": "Đang reset…",
  "admin.settings.resetDatabase": "Reset database",
  "admin.settings.secretValue": "(ẩn giá trị)",
  "admin.settings.loading": "Đang tải cấu hình…",
  "admin.settings.loadError": "Lỗi tải cấu hình",
}

const DEFAULT_ZH: Record<string, string> = {
  "app.title": "AI Portal – AI 界面与编排平台",
  "app.description": "AI 界面与编排平台：项目、助手、集成与展示。",
  "app.shortName": "AI Portal",
  "app.keywords": "AI, 项目, 助手, 集成",
  "app.author": "AI Portal",
  "nav.home": "返回首页",
  "nav.adminTitle": "管理后台",
  "nav.adminShort": "管理",
  "settings.title": "系统设置",
  "settings.subtitle": "自定义您的 AI Portal 体验",
  "settings.appearance": "外观",
  "settings.appearanceDesc": "语言与显示",
  "settings.language": "语言",
  "settings.theme": "主题",
  "settings.themeLight": "浅色",
  "settings.themeDark": "深色",
  "settings.themeSystem": "跟随系统",
  "settings.langVi": "越南语",
  "settings.langEn": "英语",
  "settings.notifications": "通知",
  "settings.notificationsDesc": "管理通知类型。默认：全部关闭。",
  "settings.notificationsEmailTo": "通知将发送至邮箱：",
  "settings.notificationsEmail": "邮件通知",
  "settings.notificationsPush": "推送通知",
  "settings.notificationsProjects": "项目更新",
  "settings.notificationsPublications": "出版机会",
  "settings.privacy": "隐私",
  "settings.privacyDesc": "控制可见信息。默认：全部关闭。",
  "settings.privacyProfile": "个人资料可见",
  "settings.privacyProjects": "项目可见",
  "settings.privacyPublications": "出版物可见",
  "settings.ai": "AI 助手",
  "settings.aiDesc": "自定义 AI 行为",
  "settings.aiPersonalization": "个性化",
  "settings.aiAutoSuggestions": "自动建议",
  "settings.aiExternalSearch": "从外部来源搜索信息",
  "settings.aiResponseLength": "回复长度",
  "settings.aiResponseShort": "短",
  "settings.aiResponseMedium": "中",
  "settings.aiResponseLong": "长",
  "settings.aiCreativity": "创意度",
  "settings.data": "数据",
  "settings.dataDesc": "存储与同步",
  "settings.dataAutoBackup": "自动备份",
  "settings.dataSync": "云同步",
  "settings.dataCacheSize": "缓存大小",
  "settings.dataClearCache": "清除缓存",
  "settings.dataExport": "导出数据",
  "settings.save": "保存设置",
  "settings.saving": "保存中...",
  "settings.saved": "设置已保存",
  "welcome.subtitle": "面向 AI 协作与工作的智能平台",
  "welcome.card1.title": "AI Portal",
  "welcome.card1.description": "统一平台，与 AI 助手交互、管理项目并扩展工作流程。",
  "welcome.card2.title": "聊天与协作",
  "welcome.card2.description": "与 AI 自然对话，协作完成各项任务。",
  "welcome.card3.title": "项目与工具",
  "welcome.card3.description": "在项目中组织工作，按需集成工具。",
  "welcome.card4.title": "自定义",
  "welcome.card4.description": "选择适合您的助手和设置。",
  "welcome.startButton": "开始使用",
  "welcome.loginButton": "登录",
  "welcome.guideButton": "使用指南",
  "welcome.hintLoggedIn": "将跳转到 AI Central 开始对话。",
  "welcome.hintLoggedOut": "登录后可创建项目、保存文章并查看聊天记录。",
  "common.save": "保存",
  "common.saving": "保存中…",
  "common.add": "添加",
  "common.cancel": "取消",
  "common.delete": "删除",
  "common.loading": "加载中…",
  "common.error": "错误",
  "common.refresh": "刷新",
  "common.actions": "操作",
  "common.filter": "筛选",
  "common.upload": "上传",
  "common.saveError": "保存错误",
  "admin.settings.languageTitle": "语言配置",
  "admin.settings.languageDesc": "选择网站默认语言。JSON 文件 (en, vi, zh, ja, fr) 为初始配置；可下载模板、编辑后上传至 data/locales。",
  "admin.settings.defaultLocaleSaved": "默认语言已保存。界面将更新为新语言。",
  "admin.settings.defaultLocale": "默认语言",
  "admin.settings.localePackage": "语言包",
  "admin.settings.downloadTemplate": "下载语言包模板",
  "admin.settings.localeCodePlaceholder": "语言代码（如 fr, de）",
  "admin.settings.uploadPackage": "上传包",
  "admin.settings.uploading": "上传中…",
  "admin.settings.pluginQdrant": "Qdrant 插件",
  "admin.settings.pluginQdrantDesc": "启用插件以在 Admin 中显示 Qdrant 选项卡；输入 Qdrant URL 管理向量数据库。",
  "admin.settings.enablePluginQdrant": "启用 Qdrant 插件",
  "admin.settings.qdrantUrl": "Qdrant URL",
  "admin.settings.qdrantUrlPlaceholder": "http://localhost:8010 或 http://qdrant:6333",
  "admin.settings.qdrantSaved": "已保存。启用插件后 Qdrant 选项卡将显示。",
  "admin.settings.envConfigTitle": "环境配置（只读）",
  "admin.settings.envConfigDesc": "应用名称、图标、数据库：在 /setup 配置。以下变量可通过 Admin 保存，启动时从 app_settings 加载。",
  "admin.settings.resetTitle": "重置应用",
  "admin.settings.resetDesc": "删除整个数据库并从 schema.sql 重建 — 应用恢复至全新安装状态。不可撤销。",
  "admin.settings.resetConfirmLabel": "输入 RESET 确认",
  "admin.settings.resetConfirmError": "输入 RESET（大写）以确认。",
  "admin.settings.resetConfirmDialog": "确定要删除所有数据并重置？此操作不可撤销。",
  "admin.settings.resetDone": "数据库已重置。",
  "admin.settings.resetting": "重置中…",
  "admin.settings.resetDatabase": "重置数据库",
  "admin.settings.secretValue": "（值已隐藏）",
  "admin.settings.loading": "正在加载配置…",
  "admin.settings.loadError": "加载配置失败",
}

const DEFAULT_JA: Record<string, string> = {
  "app.title": "AI Portal – AI の UI とオーケストレーションプラットフォーム",
  "app.description": "AI の UI とオーケストレーションプラットフォーム：プロジェクト、アシスタント、連携と表示。",
  "app.shortName": "AI Portal",
  "app.keywords": "AI, プロジェクト, アシスタント, 連携",
  "app.author": "AI Portal",
  "nav.home": "ホームに戻る",
  "nav.adminTitle": "管理ダッシュボード",
  "nav.adminShort": "管理",
  "settings.title": "システム設定",
  "settings.subtitle": "AI Portal の体験をカスタマイズ",
  "settings.appearance": "表示",
  "settings.appearanceDesc": "言語と表示",
  "settings.language": "言語",
  "settings.theme": "テーマ",
  "settings.themeLight": "ライト",
  "settings.themeDark": "ダーク",
  "settings.themeSystem": "システムに従う",
  "settings.langVi": "ベトナム語",
  "settings.langEn": "英語",
  "settings.notifications": "通知",
  "settings.notificationsDesc": "通知タイプを管理。デフォルト：すべてオフ。",
  "settings.notificationsEmailTo": "通知の送信先メール：",
  "settings.notificationsEmail": "メール通知",
  "settings.notificationsPush": "プッシュ通知",
  "settings.notificationsProjects": "プロジェクト更新",
  "settings.notificationsPublications": "出版の機会",
  "settings.privacy": "プライバシー",
  "settings.privacyDesc": "表示する情報を制御。デフォルト：すべてオフ。",
  "settings.privacyProfile": "プロフィールを公開",
  "settings.privacyProjects": "プロジェクトを公開",
  "settings.privacyPublications": "出版物を公開",
  "settings.ai": "AI アシスタント",
  "settings.aiDesc": "AI の動作をカスタマイズ",
  "settings.aiPersonalization": "パーソナライズ",
  "settings.aiAutoSuggestions": "自動提案",
  "settings.aiExternalSearch": "外部ソースから情報を検索",
  "settings.aiResponseLength": "応答の長さ",
  "settings.aiResponseShort": "短い",
  "settings.aiResponseMedium": "中",
  "settings.aiResponseLong": "長い",
  "settings.aiCreativity": "創造性",
  "settings.data": "データ",
  "settings.dataDesc": "保存と同期",
  "settings.dataAutoBackup": "自動バックアップ",
  "settings.dataSync": "クラウド同期",
  "settings.dataCacheSize": "キャッシュサイズ",
  "settings.dataClearCache": "キャッシュをクリア",
  "settings.dataExport": "データをエクスポート",
  "settings.save": "設定を保存",
  "settings.saving": "保存中...",
  "settings.saved": "設定を保存しました",
  "welcome.subtitle": "AI で仕事と協働するためのスマートプラットフォーム",
  "welcome.card1.title": "AI Portal",
  "welcome.card1.description": "AI アシスタントとの対話、プロジェクト管理、ワークフローの拡張を一元化。",
  "welcome.card2.title": "チャット＆協働",
  "welcome.card2.description": "AI と自然に会話し、タスクを協力して進めましょう。",
  "welcome.card3.title": "プロジェクト＆ツール",
  "welcome.card3.description": "プロジェクトで作業を整理し、必要なツールを統合。",
  "welcome.card4.title": "カスタマイズ",
  "welcome.card4.description": "ニーズに合わせてアシスタントと設定を選べます。",
  "welcome.startButton": "使い始める",
  "welcome.loginButton": "ログイン",
  "welcome.guideButton": "利用ガイド",
  "welcome.hintLoggedIn": "AI Central に移動してチャットを開始します。",
  "welcome.hintLoggedOut": "ログインしてプロジェクト作成、記事保存、チャット履歴を表示します。",
  "common.save": "保存",
  "common.saving": "保存中…",
  "common.add": "追加",
  "common.cancel": "キャンセル",
  "common.delete": "削除",
  "common.loading": "読み込み中…",
  "common.error": "エラー",
  "common.refresh": "更新",
  "common.actions": "操作",
  "common.filter": "フィルター",
  "common.upload": "アップロード",
  "common.saveError": "保存エラー",
  "admin.settings.languageTitle": "言語設定",
  "admin.settings.languageDesc": "サイトのデフォルト言語を選択。JSON ファイル (en, vi, zh, ja, fr) が初期設定；テンプレートをダウンロードして編集し、data/locales にアップロード可能。",
  "admin.settings.defaultLocaleSaved": "デフォルト言語を保存しました。インターフェースが更新されます。",
  "admin.settings.defaultLocale": "デフォルト言語",
  "admin.settings.localePackage": "言語パッケージ",
  "admin.settings.downloadTemplate": "言語パッケージテンプレートをダウンロード",
  "admin.settings.localeCodePlaceholder": "言語コード（例: fr, de）",
  "admin.settings.uploadPackage": "パッケージをアップロード",
  "admin.settings.uploading": "アップロード中…",
  "admin.settings.pluginQdrant": "Qdrant プラグイン",
  "admin.settings.pluginQdrantDesc": "プラグインを有効にして Admin に Qdrant タブを表示；Qdrant URL を入力してベクトル DB を管理。",
  "admin.settings.enablePluginQdrant": "Qdrant プラグインを有効にする",
  "admin.settings.qdrantUrl": "Qdrant URL",
  "admin.settings.qdrantUrlPlaceholder": "http://localhost:8010 または http://qdrant:6333",
  "admin.settings.qdrantSaved": "保存しました。プラグイン有効時に Qdrant タブが表示されます。",
  "admin.settings.envConfigTitle": "環境設定（読み取り専用）",
  "admin.settings.envConfigDesc": "アプリ名、アイコン、データベース：/setup で設定。以下の変数は Admin で保存可能；起動時に app_settings から読み込み。",
  "admin.settings.resetTitle": "アプリをリセット",
  "admin.settings.resetDesc": "データベース全体を削除し schema.sql から再作成 — アプリが初期状態に戻ります。取り消せません。",
  "admin.settings.resetConfirmLabel": "RESET と入力して確認",
  "admin.settings.resetConfirmError": "RESET（大文字）と入力して確認してください。",
  "admin.settings.resetConfirmDialog": "すべてのデータを削除してリセットしますか？取り消せません。",
  "admin.settings.resetDone": "データベースをリセットしました。",
  "admin.settings.resetting": "リセット中…",
  "admin.settings.resetDatabase": "データベースをリセット",
  "admin.settings.secretValue": "（値は非表示）",
  "admin.settings.loading": "設定を読み込み中…",
  "admin.settings.loadError": "設定の読み込みに失敗しました",
}

const DEFAULT_FR: Record<string, string> = {
  "app.title": "AI Portal – Plateforme d’interface et d’orchestration IA",
  "app.description": "Plateforme d’interface et d’orchestration IA : projets, assistants, intégration et affichage.",
  "app.shortName": "AI Portal",
  "app.keywords": "IA, projets, assistants, intégration",
  "app.author": "AI Portal",
  "nav.home": "Retour à l’accueil",
  "nav.adminTitle": "Tableau de bord Admin",
  "nav.adminShort": "Admin",
  "settings.title": "Paramètres système",
  "settings.subtitle": "Personnalisez votre expérience AI Portal",
  "settings.appearance": "Apparence",
  "settings.appearanceDesc": "Langue et affichage",
  "settings.language": "Langue",
  "settings.theme": "Thème",
  "settings.themeLight": "Clair",
  "settings.themeDark": "Sombre",
  "settings.themeSystem": "Système",
  "settings.langVi": "Vietnamien",
  "settings.langEn": "Anglais",
  "settings.notifications": "Notifications",
  "settings.notificationsDesc": "Gérer les types de notifications. Par défaut : tout désactivé.",
  "settings.notificationsEmailTo": "Les notifications seront envoyées à :",
  "settings.notificationsEmail": "Notifications par e-mail",
  "settings.notificationsPush": "Notifications push",
  "settings.notificationsProjects": "Mises à jour de projet",
  "settings.notificationsPublications": "Opportunités de publication",
  "settings.privacy": "Confidentialité",
  "settings.privacyDesc": "Contrôler les informations visibles. Par défaut : tout désactivé.",
  "settings.privacyProfile": "Profil visible",
  "settings.privacyProjects": "Projets visibles",
  "settings.privacyPublications": "Publications visibles",
  "settings.ai": "Assistant IA",
  "settings.aiDesc": "Personnaliser le comportement de l’IA",
  "settings.aiPersonalization": "Personnalisation",
  "settings.aiAutoSuggestions": "Suggestions automatiques",
  "settings.aiExternalSearch": "Rechercher des informations externes",
  "settings.aiResponseLength": "Longueur des réponses",
  "settings.aiResponseShort": "Courte",
  "settings.aiResponseMedium": "Moyenne",
  "settings.aiResponseLong": "Longue",
  "settings.aiCreativity": "Créativité",
  "settings.data": "Données",
  "settings.dataDesc": "Stockage et synchronisation",
  "settings.dataAutoBackup": "Sauvegarde automatique",
  "settings.dataSync": "Sync cloud",
  "settings.dataCacheSize": "Taille du cache",
  "settings.dataClearCache": "Vider le cache",
  "settings.dataExport": "Exporter les données",
  "settings.save": "Enregistrer",
  "settings.saving": "Enregistrement...",
  "settings.saved": "Paramètres enregistrés",
  "welcome.subtitle": "Plateforme intelligente pour le travail et la collaboration avec l’IA",
  "welcome.card1.title": "AI Portal",
  "welcome.card1.description": "Plateforme unifiée pour interagir avec les assistants IA, gérer les projets et étendre vos flux de travail.",
  "welcome.card2.title": "Chat & Collaboration",
  "welcome.card2.description": "Conversations naturelles avec l’IA et collaboration sur vos tâches.",
  "welcome.card3.title": "Projets & Outils",
  "welcome.card3.description": "Organisez le travail en projets et intégrez les outils selon vos besoins.",
  "welcome.card4.title": "Personnalisation",
  "welcome.card4.description": "Choisissez les assistants et paramètres adaptés à vos besoins.",
  "welcome.startButton": "Commencer",
  "welcome.loginButton": "Connexion",
  "welcome.guideButton": "Guide d’utilisation",
  "welcome.hintLoggedIn": "Vous serez redirigé vers AI Central pour commencer à discuter.",
  "welcome.hintLoggedOut": "Connectez-vous pour créer des projets, enregistrer des articles et voir l’historique des chats.",
  "common.save": "Enregistrer",
  "common.saving": "Enregistrement…",
  "common.add": "Ajouter",
  "common.cancel": "Annuler",
  "common.delete": "Supprimer",
  "common.loading": "Chargement…",
  "common.error": "Erreur",
  "common.refresh": "Actualiser",
  "common.actions": "Actions",
  "common.filter": "Filtrer",
  "common.upload": "Téléverser",
  "common.saveError": "Erreur d’enregistrement",
  "admin.settings.languageTitle": "Configuration des langues",
  "admin.settings.languageDesc": "Choisissez la langue par défaut du site. Les fichiers JSON (en, vi, zh, ja, fr) sont la config initiale ; téléchargez un modèle, modifiez et uploadez dans data/locales.",
  "admin.settings.defaultLocaleSaved": "Langue par défaut enregistrée. L’interface se met à jour.",
  "admin.settings.defaultLocale": "Langue par défaut",
  "admin.settings.localePackage": "Package de langue",
  "admin.settings.downloadTemplate": "Télécharger le modèle de package",
  "admin.settings.localeCodePlaceholder": "Code de locale (ex. fr, de)",
  "admin.settings.uploadPackage": "Téléverser le package",
  "admin.settings.uploading": "Téléversement…",
  "admin.settings.pluginQdrant": "Plugin Qdrant",
  "admin.settings.pluginQdrantDesc": "Activez le plugin pour afficher l’onglet Qdrant dans Admin ; entrez l’URL Qdrant pour gérer la base vectorielle.",
  "admin.settings.enablePluginQdrant": "Activer le plugin Qdrant",
  "admin.settings.qdrantUrl": "URL Qdrant",
  "admin.settings.qdrantUrlPlaceholder": "http://localhost:8010 ou http://qdrant:6333",
  "admin.settings.qdrantSaved": "Enregistré. L’onglet Qdrant s’affichera quand le plugin est activé.",
  "admin.settings.envConfigTitle": "Config environnement (lecture seule)",
  "admin.settings.envConfigDesc": "Nom de l’app, icône, base de données : configurez à /setup. Les variables ci-dessous peuvent être sauvegardées via Admin et sont chargées depuis app_settings au démarrage.",
  "admin.settings.resetTitle": "Réinitialiser l’application",
  "admin.settings.resetDesc": "Supprimer toute la base et recréer depuis schema.sql — l’application revient à l’état d’installation. Irréversible.",
  "admin.settings.resetConfirmLabel": "Tapez RESET pour confirmer",
  "admin.settings.resetConfirmError": "Tapez RESET (majuscules) pour confirmer.",
  "admin.settings.resetConfirmDialog": "Voulez-vous vraiment supprimer toutes les données et réinitialiser ? Irréversible.",
  "admin.settings.resetDone": "Base de données réinitialisée.",
  "admin.settings.resetting": "Réinitialisation…",
  "admin.settings.resetDatabase": "Réinitialiser la base",
  "admin.settings.secretValue": "(valeur masquée)",
  "admin.settings.loading": "Chargement de la configuration…",
  "admin.settings.loadError": "Échec du chargement de la configuration",
}

const DEFAULT_LOCALE_STRINGS: Record<string, Record<string, string>> = {
  en: DEFAULT_EN,
  vi: DEFAULT_VI,
  zh: DEFAULT_ZH,
  ja: DEFAULT_JA,
  fr: DEFAULT_FR,
}

/** Default packages (en, vi, zh, ja, fr) to seed into locales/ when needed. */
export const DEFAULT_LOCALE_BUNDLES: Record<string, Record<string, string>> = {
  en: DEFAULT_EN,
  vi: DEFAULT_VI,
  zh: DEFAULT_ZH,
  ja: DEFAULT_JA,
  fr: DEFAULT_FR,
}

function getLocalePath(locale: string): string {
  const safe = locale.replace(/[^a-z0-9_-]/gi, "")
  if (!safe || safe.length > 20) return ""
  return path.join(LOCALES_DIR, `${safe.toLowerCase()}.json`)
}

export async function ensureLocalesDir(): Promise<void> {
  await fs.mkdir(LOCALES_DIR, { recursive: true })
}

export async function readLocaleFile(locale: string): Promise<Record<string, string>> {
  const tryRead = async (filePath: string): Promise<Record<string, string> | null> => {
    try {
      const raw = await fs.readFile(filePath, "utf-8")
      const data = JSON.parse(raw)
      if (data && typeof data === "object" && !Array.isArray(data)) {
        const out: Record<string, string> = {}
        for (const [k, v] of Object.entries(data)) {
          if (typeof k === "string" && typeof v === "string") out[k] = v
        }
        return out
      }
    } catch {
      // file not found or invalid json
    }
    return null
  }
  const dataPath = getLocalePath(locale)
  if (dataPath) {
    const fromData = await tryRead(dataPath)
    if (fromData && Object.keys(fromData).length > 0) return fromData
  }
  return DEFAULT_LOCALE_STRINGS[locale] ?? {}
}

/** Default keys (en) for template download. */
export function getTemplateStrings(): Record<string, string> {
  return { ...DEFAULT_EN }
}

export async function writeLocaleFile(locale: string, strings: Record<string, string>): Promise<void> {
  const filePath = getLocalePath(locale)
  if (!filePath) throw new Error("Invalid locale")
  await ensureLocalesDir()
  await fs.writeFile(filePath, JSON.stringify(strings, null, 2), "utf-8")
}

/** List of available locale codes: built-in (en, vi, zh, ja, fr) + files in data/locales. */
export async function listLocaleFiles(): Promise<string[]> {
  const codes = new Set<string>(BUILTIN_LOCALE_CODES)
  try {
    await ensureLocalesDir()
    const files = await fs.readdir(LOCALES_DIR)
    for (const f of files) {
      if (f.endsWith(".json")) {
        const code = f.slice(0, -5).toLowerCase()
        if (code && /^[a-z0-9_-]+$/.test(code)) codes.add(code)
      }
    }
  } catch {
    // data/locales may not exist yet
  }
  return [...codes].sort()
}
