/**
 * Locale packages: chuỗi mặc định nằm trong code (DEFAULT_LOCALE_STRINGS).
 * Admin có thể tải template (GET locale-packages/template) và upload gói ngôn ngữ mới → ghi vào data/locales/{locale}.json.
 * readLocaleFile: ưu tiên data/locales/{locale}.json, không có thì fallback DEFAULT_LOCALE_STRINGS.
 */
import fs from "fs/promises"
import path from "path"

/** Thư mục gói ngôn ngữ do admin upload/cấu hình (data/locales). */
const LOCALES_DIR = path.join(process.cwd(), "data", "locales")

/** Các mã ngôn ngữ có sẵn trong code (fallback khi chưa có file trong data/locales). */
const BUILTIN_LOCALE_CODES = ["en", "vi", "zh", "ja", "fr"] as const

const DEFAULT_EN: Record<string, string> = {
  "app.title": "AI Portal – UI and orchestration platform for AI",
  "app.description": "UI and orchestration platform for AI: projects, assistants, integration and display.",
  "app.shortName": "AI Portal",
  "app.keywords": "AI, projects, assistants, integration",
  "app.author": "AI Portal",
  "nav.home": "Back to home",
  "nav.adminTitle": "Admin Dashboard",
  "nav.adminShort": "Admin",
  "settings.title": "System Settings",
  "settings.subtitle": "Customize your AI Portal experience",
  "settings.appearance": "Appearance",
  "settings.appearanceDesc": "Language and display",
  "settings.language": "Language",
  "settings.theme": "Theme",
  "settings.themeLight": "Light",
  "settings.themeDark": "Dark",
  "settings.themeSystem": "System",
  "settings.langVi": "Tiếng Việt",
  "settings.langEn": "English",
  "settings.notifications": "Notifications",
  "settings.notificationsDesc": "Manage notification types. Default: all off.",
  "settings.notificationsEmailTo": "Notifications will be sent to email:",
  "settings.notificationsEmail": "Email notifications",
  "settings.notificationsPush": "Push notifications",
  "settings.notificationsProjects": "Project updates",
  "settings.notificationsPublications": "Publication opportunities",
  "settings.privacy": "Privacy",
  "settings.privacyDesc": "Control what information is visible. Default: all off.",
  "settings.privacyProfile": "Profile visible",
  "settings.privacyProjects": "Projects visible",
  "settings.privacyPublications": "Publications visible",
  "settings.ai": "AI Assistant",
  "settings.aiDesc": "Customize AI behavior",
  "settings.aiPersonalization": "Personalization",
  "settings.aiAutoSuggestions": "Auto suggestions",
  "settings.aiExternalSearch": "Search for information from external sources",
  "settings.aiResponseLength": "Response length",
  "settings.aiResponseShort": "Short",
  "settings.aiResponseMedium": "Medium",
  "settings.aiResponseLong": "Long",
  "settings.aiCreativity": "Creativity",
  "settings.data": "Data",
  "settings.dataDesc": "Storage and sync",
  "settings.dataAutoBackup": "Auto backup",
  "settings.dataSync": "Cloud sync",
  "settings.dataCacheSize": "Cache size",
  "settings.dataClearCache": "Clear cache",
  "settings.dataExport": "Export data",
  "settings.save": "Save settings",
  "settings.saving": "Saving...",
  "settings.saved": "Settings saved",
  "welcome.subtitle": "AI platform for teaching and work",
  "welcome.card1.title": "Main Assistant",
  "welcome.card1.description": "Exchange ideas, find documents, support writing and data processing with AI.",
  "welcome.card2.title": "Project",
  "welcome.card2.description": "Create and manage projects; assistants and apps work within a project.",
  "welcome.card3.title": "Applications",
  "welcome.card3.description": "Extend system capabilities and integrate tools and workflows into projects.",
  "welcome.card4.title": "Specialized Assistant",
  "welcome.card4.description": "Choose other specialized assistants to support work",
  "welcome.startButton": "Get started",
  "welcome.loginButton": "Log in",
  "welcome.guideButton": "User guide",
  "welcome.hintLoggedIn": "You will be taken to AI Central to start chatting.",
  "welcome.hintLoggedOut": "Log in to create projects, save articles and view chat history.",
  "common.save": "Save",
  "common.saving": "Saving…",
  "common.add": "Add",
  "common.cancel": "Cancel",
  "common.delete": "Delete",
  "common.loading": "Loading…",
  "common.error": "Error",
  "common.refresh": "Refresh",
  "common.actions": "Actions",
  "common.filter": "Filter",
  "common.upload": "Upload",
  "common.saveError": "Save error",
  "admin.settings.languageTitle": "Language configuration",
  "admin.settings.languageDesc": "Choose the default language for the website. JSON files (en, vi, zh, ja, fr) are the initial config; you can download a template, edit and upload to data/locales.",
  "admin.settings.defaultLocaleSaved": "Default language saved. The interface will update to the new language.",
  "admin.settings.defaultLocale": "Default language",
  "admin.settings.localePackage": "Language package",
  "admin.settings.downloadTemplate": "Download language package template",
  "admin.settings.localeCodePlaceholder": "Locale code (e.g. fr, de)",
  "admin.settings.uploadPackage": "Upload package",
  "admin.settings.uploading": "Uploading…",
  "admin.settings.pluginQdrant": "Plugin Qdrant",
  "admin.settings.pluginQdrantDesc": "Enable the plugin to show the Qdrant tab in Admin; enter the Qdrant URL to manage the vector DB.",
  "admin.settings.enablePluginQdrant": "Enable Qdrant plugin",
  "admin.settings.qdrantUrl": "Qdrant URL",
  "admin.settings.qdrantUrlPlaceholder": "http://localhost:8010 or http://qdrant:6333",
  "admin.settings.qdrantSaved": "Saved. The Qdrant tab will appear when the plugin is enabled.",
  "admin.settings.envConfigTitle": "Environment config (read-only)",
  "admin.settings.envConfigDesc": "App name, icon, database: configure at /setup. The variables below can be saved via Admin and are loaded from app_settings on startup.",
  "admin.settings.resetTitle": "Reset application",
  "admin.settings.resetDesc": "Delete the entire database and recreate from schema.sql — application returns to fresh install state. Cannot be undone.",
  "admin.settings.resetConfirmLabel": "Type RESET to confirm",
  "admin.settings.resetConfirmError": "Type RESET (uppercase) to confirm.",
  "admin.settings.resetConfirmDialog": "Are you sure you want to delete all data and reset? This cannot be undone.",
  "admin.settings.resetDone": "Database has been reset.",
  "admin.settings.resetting": "Resetting…",
  "admin.settings.resetDatabase": "Reset database",
  "admin.settings.secretValue": "(value hidden)",
  "admin.settings.loading": "Loading configuration…",
  "admin.settings.loadError": "Failed to load configuration",
}

const DEFAULT_VI: Record<string, string> = {
  "app.title": "AI Portal – Nền tảng giao diện và điều phối AI",
  "app.description": "Nền tảng giao diện và điều phối AI: quản lý dự án, trợ lý ảo, tích hợp và hiển thị AI.",
  "app.shortName": "AI Portal",
  "app.keywords": "AI, dự án, trợ lý ảo, quản lý dự án, tích hợp AI",
  "app.author": "AI Portal",
  "nav.home": "Về trang chủ",
  "nav.adminTitle": "Admin Dashboard",
  "nav.adminShort": "Admin",
  "settings.title": "Cài đặt hệ thống",
  "settings.subtitle": "Tùy chỉnh trải nghiệm sử dụng AI Portal",
  "settings.appearance": "Giao diện",
  "settings.appearanceDesc": "Tùy chỉnh ngôn ngữ và giao diện",
  "settings.language": "Ngôn ngữ",
  "settings.theme": "Chủ đề",
  "settings.themeLight": "Sáng",
  "settings.themeDark": "Tối",
  "settings.themeSystem": "Theo hệ thống",
  "settings.langVi": "Tiếng Việt",
  "settings.langEn": "English",
  "settings.notifications": "Thông báo",
  "settings.notificationsDesc": "Quản lý các loại thông báo. Mặc định tắt.",
  "settings.notificationsEmailTo": "Thông báo sẽ gửi đến email:",
  "settings.notificationsEmail": "Thông báo email",
  "settings.notificationsPush": "Thông báo đẩy",
  "settings.notificationsProjects": "Cập nhật dự án",
  "settings.notificationsPublications": "Cơ hội công bố",
  "settings.privacy": "Quyền riêng tư",
  "settings.privacyDesc": "Kiểm soát thông tin hiển thị. Mặc định tắt.",
  "settings.privacyProfile": "Hồ sơ công khai",
  "settings.privacyProjects": "Dự án công khai",
  "settings.privacyPublications": "Công bố công khai",
  "settings.ai": "Trợ lý AI",
  "settings.aiDesc": "Tùy chỉnh hành vi của AI",
  "settings.aiPersonalization": "Cá nhân hóa",
  "settings.aiAutoSuggestions": "Gợi ý tự động",
  "settings.aiExternalSearch": "Tìm kiếm thông tin từ bên ngoài",
  "settings.aiResponseLength": "Độ dài phản hồi",
  "settings.aiResponseShort": "Ngắn",
  "settings.aiResponseMedium": "Trung bình",
  "settings.aiResponseLong": "Dài",
  "settings.aiCreativity": "Độ sáng tạo",
  "settings.data": "Dữ liệu",
  "settings.dataDesc": "Quản lý lưu trữ và đồng bộ",
  "settings.dataAutoBackup": "Sao lưu tự động",
  "settings.dataSync": "Đồng bộ đám mây",
  "settings.dataCacheSize": "Kích thước cache",
  "settings.dataClearCache": "Xóa cache",
  "settings.dataExport": "Xuất dữ liệu",
  "settings.save": "Lưu cài đặt",
  "settings.saving": "Đang lưu...",
  "settings.saved": "Đã lưu cài đặt",
  "welcome.subtitle": "Nền tảng trí tuệ nhân tạo phục vụ giảng dạy và làm việc",
  "welcome.card1.title": "Trợ lý chính",
  "welcome.card1.description": "Trao đổi ý tưởng, tìm tài liệu, hỗ trợ soạn bài và xử lý dữ liệu với AI.",
  "welcome.card2.title": "Dự án",
  "welcome.card2.description": "Tạo và quản lý dự án, các trợ lý và ứng dụng sẽ làm việc với dự án",
  "welcome.card3.title": "Ứng dụng",
  "welcome.card3.description": "Mở rộng chức năng hệ thống, tích hợp công cụ và quy trình làm việc vào dự án.",
  "welcome.card4.title": "Trợ lý chuyên biệt",
  "welcome.card4.description": "Chọn trợ lý chuyên biệt khác để hỗ trợ công việc",
  "welcome.startButton": "Bắt đầu sử dụng",
  "welcome.loginButton": "Đăng nhập",
  "welcome.guideButton": "Hướng dẫn sử dụng",
  "welcome.hintLoggedIn": "Bạn sẽ được chuyển đến AI Central để bắt đầu trò chuyện.",
  "welcome.hintLoggedOut": "Đăng nhập để tạo dự án, lưu bài viết và xem lịch sử chat.",
  "common.save": "Lưu",
  "common.saving": "Đang lưu…",
  "common.add": "Thêm",
  "common.cancel": "Hủy",
  "common.delete": "Xóa",
  "common.loading": "Đang tải…",
  "common.error": "Lỗi",
  "common.refresh": "Làm mới",
  "common.actions": "Thao tác",
  "common.filter": "Lọc",
  "common.upload": "Tải lên",
  "common.saveError": "Lỗi lưu",
  "admin.settings.languageTitle": "Cấu hình ngôn ngữ",
  "admin.settings.languageDesc": "Chọn ngôn ngữ mặc định cho website. Các file JSON (en, vi, zh, ja, fr) là cấu hình ban đầu; có thể tải mẫu gói ngôn ngữ, chỉnh sửa và upload vào data/locales.",
  "admin.settings.defaultLocaleSaved": "Đã lưu ngôn ngữ mặc định. Giao diện sẽ cập nhật theo ngôn ngữ mới.",
  "admin.settings.defaultLocale": "Ngôn ngữ mặc định",
  "admin.settings.localePackage": "Gói ngôn ngữ",
  "admin.settings.downloadTemplate": "Tải mẫu gói ngôn ngữ",
  "admin.settings.localeCodePlaceholder": "Mã ngôn ngữ (vd. fr, de)",
  "admin.settings.uploadPackage": "Upload gói",
  "admin.settings.uploading": "Đang tải lên…",
  "admin.settings.pluginQdrant": "Plugin Qdrant",
  "admin.settings.pluginQdrantDesc": "Bật plugin để hiển thị tab Qdrant trong Admin, nhập địa chỉ Qdrant để quản lý vector DB.",
  "admin.settings.enablePluginQdrant": "Bật plugin Qdrant",
  "admin.settings.qdrantUrl": "Địa chỉ Qdrant (URL)",
  "admin.settings.qdrantUrlPlaceholder": "http://localhost:8010 hoặc http://qdrant:6333",
  "admin.settings.qdrantSaved": "Đã lưu. Tab Qdrant sẽ hiển thị khi bật plugin.",
  "admin.settings.envConfigTitle": "Cấu hình môi trường (chỉ đọc)",
  "admin.settings.envConfigDesc": "Tên ứng dụng, icon, tên database: cấu hình tại /setup. Các biến bên dưới có thể lưu qua Admin và được nạp từ app_settings khi khởi động.",
  "admin.settings.resetTitle": "Reset ứng dụng",
  "admin.settings.resetDesc": "Xoá toàn bộ database đã tạo và tạo lại từ schema.sql — ứng dụng về trạng thái cài mới. Không thể hoàn tác.",
  "admin.settings.resetConfirmLabel": "Nhập RESET để xác nhận",
  "admin.settings.resetConfirmError": "Nhập đúng chữ RESET (viết hoa) để xác nhận.",
  "admin.settings.resetConfirmDialog": "Bạn chắc chắn muốn xoá toàn bộ dữ liệu và thiết lập lại? Hành động này không thể hoàn tác.",
  "admin.settings.resetDone": "Đã reset database.",
  "admin.settings.resetting": "Đang reset…",
  "admin.settings.resetDatabase": "Reset database",
  "admin.settings.secretValue": "(ẩn giá trị)",
  "admin.settings.loading": "Đang tải cấu hình…",
  "admin.settings.loadError": "Lỗi tải cấu hình",
}

const DEFAULT_ZH: Record<string, string> = {
  "app.title": "AI Portal – AI 界面与编排平台",
  "app.description": "AI 界面与编排平台：项目、助手、集成与展示。",
  "app.shortName": "AI Portal",
  "app.keywords": "AI, 项目, 助手, 集成",
  "app.author": "AI Portal",
  "nav.home": "返回首页",
  "nav.adminTitle": "管理后台",
  "nav.adminShort": "管理",
  "settings.title": "系统设置",
  "settings.subtitle": "自定义您的 AI Portal 体验",
  "settings.appearance": "外观",
  "settings.appearanceDesc": "语言与显示",
  "settings.language": "语言",
  "settings.theme": "主题",
  "settings.themeLight": "浅色",
  "settings.themeDark": "深色",
  "settings.themeSystem": "跟随系统",
  "settings.langVi": "越南语",
  "settings.langEn": "英语",
  "settings.notifications": "通知",
  "settings.notificationsDesc": "管理通知类型。默认：全部关闭。",
  "settings.notificationsEmailTo": "通知将发送至邮箱：",
  "settings.notificationsEmail": "邮件通知",
  "settings.notificationsPush": "推送通知",
  "settings.notificationsProjects": "项目更新",
  "settings.notificationsPublications": "出版机会",
  "settings.privacy": "隐私",
  "settings.privacyDesc": "控制可见信息。默认：全部关闭。",
  "settings.privacyProfile": "个人资料可见",
  "settings.privacyProjects": "项目可见",
  "settings.privacyPublications": "出版物可见",
  "settings.ai": "AI 助手",
  "settings.aiDesc": "自定义 AI 行为",
  "settings.aiPersonalization": "个性化",
  "settings.aiAutoSuggestions": "自动建议",
  "settings.aiExternalSearch": "从外部来源搜索信息",
  "settings.aiResponseLength": "回复长度",
  "settings.aiResponseShort": "短",
  "settings.aiResponseMedium": "中",
  "settings.aiResponseLong": "长",
  "settings.aiCreativity": "创意度",
  "settings.data": "数据",
  "settings.dataDesc": "存储与同步",
  "settings.dataAutoBackup": "自动备份",
  "settings.dataSync": "云同步",
  "settings.dataCacheSize": "缓存大小",
  "settings.dataClearCache": "清除缓存",
  "settings.dataExport": "导出数据",
  "settings.save": "保存设置",
  "settings.saving": "保存中...",
  "settings.saved": "设置已保存",
  "welcome.subtitle": "面向教学与工作的 AI 平台",
  "welcome.card1.title": "主助手",
  "welcome.card1.description": "交流想法、查找文档，支持写作与数据处理。",
  "welcome.card2.title": "项目",
  "welcome.card2.description": "创建和管理项目，助手与应用在项目内工作。",
  "welcome.card3.title": "应用",
  "welcome.card3.description": "扩展系统功能，将工具与工作流程集成到项目中。",
  "welcome.card4.title": "专业助手",
  "welcome.card4.description": "选择其他专业助手协助工作",
  "welcome.startButton": "开始使用",
  "welcome.loginButton": "登录",
  "welcome.guideButton": "使用指南",
  "welcome.hintLoggedIn": "将跳转到 AI Central 开始对话。",
  "welcome.hintLoggedOut": "登录后可创建项目、保存文章并查看聊天记录。",
}

const DEFAULT_JA: Record<string, string> = {
  "app.title": "AI Portal – AI の UI とオーケストレーションプラットフォーム",
  "app.description": "AI の UI とオーケストレーションプラットフォーム：プロジェクト、アシスタント、連携と表示。",
  "app.shortName": "AI Portal",
  "app.keywords": "AI, プロジェクト, アシスタント, 連携",
  "app.author": "AI Portal",
  "nav.home": "ホームに戻る",
  "nav.adminTitle": "管理ダッシュボード",
  "nav.adminShort": "管理",
  "settings.title": "システム設定",
  "settings.subtitle": "AI Portal の体験をカスタマイズ",
  "settings.appearance": "表示",
  "settings.appearanceDesc": "言語と表示",
  "settings.language": "言語",
  "settings.theme": "テーマ",
  "settings.themeLight": "ライト",
  "settings.themeDark": "ダーク",
  "settings.themeSystem": "システムに従う",
  "settings.langVi": "ベトナム語",
  "settings.langEn": "英語",
  "settings.notifications": "通知",
  "settings.notificationsDesc": "通知タイプを管理。デフォルト：すべてオフ。",
  "settings.notificationsEmailTo": "通知の送信先メール：",
  "settings.notificationsEmail": "メール通知",
  "settings.notificationsPush": "プッシュ通知",
  "settings.notificationsProjects": "プロジェクト更新",
  "settings.notificationsPublications": "出版の機会",
  "settings.privacy": "プライバシー",
  "settings.privacyDesc": "表示する情報を制御。デフォルト：すべてオフ。",
  "settings.privacyProfile": "プロフィールを公開",
  "settings.privacyProjects": "プロジェクトを公開",
  "settings.privacyPublications": "出版物を公開",
  "settings.ai": "AI アシスタント",
  "settings.aiDesc": "AI の動作をカスタマイズ",
  "settings.aiPersonalization": "パーソナライズ",
  "settings.aiAutoSuggestions": "自動提案",
  "settings.aiExternalSearch": "外部ソースから情報を検索",
  "settings.aiResponseLength": "応答の長さ",
  "settings.aiResponseShort": "短い",
  "settings.aiResponseMedium": "中",
  "settings.aiResponseLong": "長い",
  "settings.aiCreativity": "創造性",
  "settings.data": "データ",
  "settings.dataDesc": "保存と同期",
  "settings.dataAutoBackup": "自動バックアップ",
  "settings.dataSync": "クラウド同期",
  "settings.dataCacheSize": "キャッシュサイズ",
  "settings.dataClearCache": "キャッシュをクリア",
  "settings.dataExport": "データをエクスポート",
  "settings.save": "設定を保存",
  "settings.saving": "保存中...",
  "settings.saved": "設定を保存しました",
  "welcome.subtitle": "教育と仕事のための AI プラットフォーム",
  "welcome.card1.title": "メインアシスタント",
  "welcome.card1.description": "アイデアの交換、ドキュメント検索、執筆とデータ処理を AI でサポート。",
  "welcome.card2.title": "プロジェクト",
  "welcome.card2.description": "作成と管理。アシスタントとアプリはプロジェクト内で作業。",
  "welcome.card3.title": "アプリ",
  "welcome.card3.description": "システム機能を拡張し、ツールとワークフローをプロジェクトに統合。",
  "welcome.card4.title": "専門アシスタント",
  "welcome.card4.description": "他の専門アシスタントを選んで作業をサポート",
  "welcome.startButton": "使い始める",
  "welcome.loginButton": "ログイン",
  "welcome.guideButton": "利用ガイド",
  "welcome.hintLoggedIn": "AI Central に移動してチャットを開始します。",
  "welcome.hintLoggedOut": "ログインしてプロジェクト作成、記事保存、チャット履歴を表示します。",
}

const DEFAULT_FR: Record<string, string> = {
  "app.title": "AI Portal – Plateforme d’interface et d’orchestration IA",
  "app.description": "Plateforme d’interface et d’orchestration IA : projets, assistants, intégration et affichage.",
  "app.shortName": "AI Portal",
  "app.keywords": "IA, projets, assistants, intégration",
  "app.author": "AI Portal",
  "nav.home": "Retour à l’accueil",
  "nav.adminTitle": "Tableau de bord Admin",
  "nav.adminShort": "Admin",
  "settings.title": "Paramètres système",
  "settings.subtitle": "Personnalisez votre expérience AI Portal",
  "settings.appearance": "Apparence",
  "settings.appearanceDesc": "Langue et affichage",
  "settings.language": "Langue",
  "settings.theme": "Thème",
  "settings.themeLight": "Clair",
  "settings.themeDark": "Sombre",
  "settings.themeSystem": "Système",
  "settings.langVi": "Vietnamien",
  "settings.langEn": "Anglais",
  "settings.notifications": "Notifications",
  "settings.notificationsDesc": "Gérer les types de notifications. Par défaut : tout désactivé.",
  "settings.notificationsEmailTo": "Les notifications seront envoyées à :",
  "settings.notificationsEmail": "Notifications par e-mail",
  "settings.notificationsPush": "Notifications push",
  "settings.notificationsProjects": "Mises à jour de projet",
  "settings.notificationsPublications": "Opportunités de publication",
  "settings.privacy": "Confidentialité",
  "settings.privacyDesc": "Contrôler les informations visibles. Par défaut : tout désactivé.",
  "settings.privacyProfile": "Profil visible",
  "settings.privacyProjects": "Projets visibles",
  "settings.privacyPublications": "Publications visibles",
  "settings.ai": "Assistant IA",
  "settings.aiDesc": "Personnaliser le comportement de l’IA",
  "settings.aiPersonalization": "Personnalisation",
  "settings.aiAutoSuggestions": "Suggestions automatiques",
  "settings.aiExternalSearch": "Rechercher des informations externes",
  "settings.aiResponseLength": "Longueur des réponses",
  "settings.aiResponseShort": "Courte",
  "settings.aiResponseMedium": "Moyenne",
  "settings.aiResponseLong": "Longue",
  "settings.aiCreativity": "Créativité",
  "settings.data": "Données",
  "settings.dataDesc": "Stockage et synchronisation",
  "settings.dataAutoBackup": "Sauvegarde automatique",
  "settings.dataSync": "Sync cloud",
  "settings.dataCacheSize": "Taille du cache",
  "settings.dataClearCache": "Vider le cache",
  "settings.dataExport": "Exporter les données",
  "settings.save": "Enregistrer",
  "settings.saving": "Enregistrement...",
  "settings.saved": "Paramètres enregistrés",
  "welcome.subtitle": "Plateforme IA pour l’enseignement et le travail",
  "welcome.card1.title": "Assistant principal",
  "welcome.card1.description": "Échanger des idées, trouver des documents, soutenir la rédaction et le traitement des données avec l’IA.",
  "welcome.card2.title": "Projet",
  "welcome.card2.description": "Créer et gérer des projets ; assistants et applications travaillent dans le projet.",
  "welcome.card3.title": "Applications",
  "welcome.card3.description": "Étendent le système et intègrent outils et flux de travail aux projets.",
  "welcome.card4.title": "Assistant spécialisé",
  "welcome.card4.description": "Choisir d’autres assistants spécialisés pour le travail",
  "welcome.startButton": "Commencer",
  "welcome.loginButton": "Connexion",
  "welcome.guideButton": "Guide d’utilisation",
  "welcome.hintLoggedIn": "Vous serez redirigé vers AI Central pour commencer à discuter.",
  "welcome.hintLoggedOut": "Connectez-vous pour créer des projets, enregistrer des articles et voir l’historique des chats.",
}

const DEFAULT_LOCALE_STRINGS: Record<string, Record<string, string>> = {
  en: DEFAULT_EN,
  vi: DEFAULT_VI,
  zh: DEFAULT_ZH,
  ja: DEFAULT_JA,
  fr: DEFAULT_FR,
}

/** Các gói mặc định (en, vi, zh, ja, fr) để seed vào thư mục locales/ khi cần. */
export const DEFAULT_LOCALE_BUNDLES: Record<string, Record<string, string>> = {
  en: DEFAULT_EN,
  vi: DEFAULT_VI,
  zh: DEFAULT_ZH,
  ja: DEFAULT_JA,
  fr: DEFAULT_FR,
}

function getLocalePath(locale: string): string {
  const safe = locale.replace(/[^a-z0-9_-]/gi, "")
  if (!safe || safe.length > 20) return ""
  return path.join(LOCALES_DIR, `${safe.toLowerCase()}.json`)
}

export async function ensureLocalesDir(): Promise<void> {
  await fs.mkdir(LOCALES_DIR, { recursive: true })
}

export async function readLocaleFile(locale: string): Promise<Record<string, string>> {
  const tryRead = async (filePath: string): Promise<Record<string, string> | null> => {
    try {
      const raw = await fs.readFile(filePath, "utf-8")
      const data = JSON.parse(raw)
      if (data && typeof data === "object" && !Array.isArray(data)) {
        const out: Record<string, string> = {}
        for (const [k, v] of Object.entries(data)) {
          if (typeof k === "string" && typeof v === "string") out[k] = v
        }
        return out
      }
    } catch {
      // file not found or invalid json
    }
    return null
  }
  const dataPath = getLocalePath(locale)
  if (dataPath) {
    const fromData = await tryRead(dataPath)
    if (fromData && Object.keys(fromData).length > 0) return fromData
  }
  return DEFAULT_LOCALE_STRINGS[locale] ?? {}
}

/** Default keys (en) for template download. */
export function getTemplateStrings(): Record<string, string> {
  return { ...DEFAULT_EN }
}

export async function writeLocaleFile(locale: string, strings: Record<string, string>): Promise<void> {
  const filePath = getLocalePath(locale)
  if (!filePath) throw new Error("Invalid locale")
  await ensureLocalesDir()
  await fs.writeFile(filePath, JSON.stringify(strings, null, 2), "utf-8")
}

/** Danh sách mã ngôn ngữ có sẵn: built-in (en, vi, zh, ja, fr) + các file trong data/locales. */
export async function listLocaleFiles(): Promise<string[]> {
  const codes = new Set<string>(BUILTIN_LOCALE_CODES)
  try {
    await ensureLocalesDir()
    const files = await fs.readdir(LOCALES_DIR)
    for (const f of files) {
      if (f.endsWith(".json")) {
        const code = f.slice(0, -5).toLowerCase()
        if (code && /^[a-z0-9_-]+$/.test(code)) codes.add(code)
      }
    }
  } catch {
    // data/locales may not exist yet
  }
  return [...codes].sort()
}
